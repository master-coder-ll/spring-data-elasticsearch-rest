/* * Copyright (C) 2018 Yoann Despréaux * * This program is free software; you can redistribute it and/or modify * it under the terms of the GNU General Public License as published by * the Free Software Foundation; either version 2 of the License, or * (at your option) any later version. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the * GNU General Public License for more details. * * You should have received a copy of the GNU General Public License * along with this program; see the file COPYING . If not, write to the * Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. * * Please send bugreports with examples or suggestions to yoann.despreaux@believeit.fr */package com.github.ydespreaux.spring.data.elasticsearch.repository.support;import com.github.ydespreaux.spring.data.elasticsearch.client.ClientLoggerAspect;import com.github.ydespreaux.spring.data.elasticsearch.configuration.ElasticsearchConfigurationSupport;import com.github.ydespreaux.spring.data.elasticsearch.core.query.Criteria;import com.github.ydespreaux.spring.data.elasticsearch.core.scroll.ScrolledPage;import com.github.ydespreaux.spring.data.elasticsearch.entities.Article;import com.github.ydespreaux.spring.data.elasticsearch.entities.ArticleInfo;import com.github.ydespreaux.spring.data.elasticsearch.repositories.template.ArticleRepository;import com.github.ydespreaux.spring.data.elasticsearch.repository.config.EnableElasticsearchRepositories;import org.elasticsearch.index.query.QueryBuilders;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.autoconfigure.EnableAutoConfiguration;import org.springframework.boot.autoconfigure.elasticsearch.rest.RestClientAutoConfiguration;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.context.annotation.EnableAspectJAutoProxy;import org.springframework.context.annotation.Profile;import org.springframework.data.domain.Page;import org.springframework.data.domain.PageRequest;import org.springframework.data.domain.Pageable;import org.springframework.data.domain.Sort;import org.springframework.test.context.junit4.SpringRunner;import java.time.Duration;import java.util.List;import java.util.Optional;import java.util.UUID;import static org.hamcrest.Matchers.*;import static org.junit.Assert.assertThat;import static org.junit.Assert.assertTrue;/** * @author Yoann Despréaux * @since 1.0.0 */@RunWith(SpringRunner.class)@SpringBootTest(classes = {        RestClientAutoConfiguration.class,        ITArticleRepositoryTest.ElasticsearchConfiguration.class})@Profile("test-no-template")public class ITArticleRepositoryTest {    @Autowired    private ArticleRepository repository;    @Test    public void findById() {        Article articleIndexed = repository.findById("1").get();        Optional<Article> optionalArticle = this.repository.findById(articleIndexed.getDocumentId());        assertTrue(optionalArticle.isPresent());        Article articleLoaded = optionalArticle.get();        assertThat(articleLoaded.getDocumentId(), is(equalTo(articleIndexed.getDocumentId())));        assertThat(articleLoaded.getName(), is(equalTo(articleIndexed.getName())));        assertThat(articleLoaded.getDescription(), is(equalTo(articleIndexed.getDescription())));        assertThat(articleLoaded.getEntrepot(), is(equalTo(articleIndexed.getEntrepot())));        assertThat(articleLoaded.getDocumentVersion(), is(equalTo(1L)));    }    @Test    public void existsById() {        assertThat(this.repository.existsById("1"), is(true));    }    @Test    public void findByIdNotFound() {        Optional<Article> optionalArticle = this.repository.findById(UUID.randomUUID().toString());        assertThat(optionalArticle.isPresent(), is(false));    }    @Test    public void notExistsById() {        assertThat(this.repository.existsById(UUID.randomUUID().toString()), is(false));    }    @Test    public void findByNameQueryNotExists() {        Article result = this.repository.findByNameQuery("Article-undefined");        assertThat(result, is(nullValue()));    }    @Test    public void searchByEntrepot_withoutSort() {        List<Article> result = this.repository.findByQuery(QueryBuilders.matchQuery("entrepot", "E1"), (Sort) null);        assertThat(result.size(), is(equalTo(3)));        for (Article article : result) {            assertThat(article.getDocumentId(), is(notNullValue()));            assertThat(article.getDocumentVersion(), is(notNullValue()));        }    }    @Test    public void searchByEntrepot_withSort() {        List<Article> result = this.repository.findByQuery(QueryBuilders.matchQuery("entrepot", "E1"), Sort.by(Sort.Direction.DESC, "name"));        assertThat(result.size(), is(equalTo(3)));        for (Article article : result) {            assertThat(article.getDocumentId(), is(notNullValue()));            assertThat(article.getDocumentVersion(), is(notNullValue()));        }        assertThat(result.get(0).getName(), is(equalTo("Article5")));        assertThat(result.get(1).getName(), is(equalTo("Article4")));        assertThat(result.get(2).getName(), is(equalTo("Article1")));    }    @Test    public void searchArticleInfoByEntrepot_withSort() {        List<ArticleInfo> result = this.repository.findByQuery(QueryBuilders.matchQuery("entrepot", "E1"), Sort.by(Sort.Direction.DESC, "name"), ArticleInfo.class);        assertThat(result.size(), is(equalTo(3)));        for (ArticleInfo article : result) {            assertThat(article.getDocumentId(), is(notNullValue()));        }        assertThat(result.get(0).getName(), is(equalTo("Article5")));        assertThat(result.get(1).getName(), is(equalTo("Article4")));        assertThat(result.get(2).getName(), is(equalTo("Article1")));    }    @Test    public void searchByDescription_withSort() {        List<Article> result = this.repository.findByQuery(QueryBuilders.matchPhraseQuery("description", "Description"), Sort.by(Sort.Direction.ASC, "name"));        assertThat(result.size(), is(equalTo(5)));        for (Article article : result) {            assertThat(article.getDocumentId(), is(notNullValue()));            assertThat(article.getDocumentVersion(), is(notNullValue()));        }        assertThat(result.get(0).getName(), is(equalTo("Article1")));        assertThat(result.get(1).getName(), is(equalTo("Article2")));        assertThat(result.get(2).getName(), is(equalTo("Article3")));        assertThat(result.get(3).getName(), is(equalTo("Article4")));        assertThat(result.get(4).getName(), is(equalTo("Article5")));    }    @Test    public void searchByDescription_withScroll() {        Pageable pageable = PageRequest.of(0, 2, Sort.by(Sort.Direction.ASC, "name"));        Duration scrollTime = Duration.ofMinutes(1);        Page<Article> result = this.repository.findByQuery(QueryBuilders.matchAllQuery(), pageable);        String scrollId = ((ScrolledPage<Article>) result).getScrollId();        assertThat(scrollId, is(notNullValue()));        assertThat(result.getTotalElements(), is(equalTo(5L)));        assertThat(result.getContent().size(), is(equalTo(2)));        assertThat(result.getContent().get(0).getName(), is(equalTo("Article1")));        assertThat(result.getContent().get(1).getName(), is(equalTo("Article2")));        result = this.repository.continueScroll(scrollId, scrollTime);        assertThat(result.getTotalElements(), is(equalTo(5L)));        assertThat(result.getContent().size(), is(equalTo(2)));        assertThat(result.getContent().get(0).getName(), is(equalTo("Article3")));        assertThat(result.getContent().get(1).getName(), is(equalTo("Article4")));        result = this.repository.continueScroll(scrollId, scrollTime);        assertThat(result.getTotalElements(), is(equalTo(5L)));        assertThat(result.getContent().size(), is(equalTo(1)));        assertThat(result.getContent().get(0).getName(), is(equalTo("Article5")));        result = this.repository.continueScroll(scrollId, scrollTime);        assertThat(result.getTotalElements(), is(equalTo(5L)));        assertThat(result.getContent().size(), is(equalTo(0)));    }    @Test    public void searchByAllFields_1_withSort() {        List<Article> result = this.repository.findByQuery(QueryBuilders.matchPhraseQuery("search_fields", "City"), Sort.by(Sort.Direction.ASC, "name"));        assertThat(result.size(), is(equalTo(1)));        for (Article article : result) {            assertThat(article.getDocumentId(), is(notNullValue()));            assertThat(article.getDocumentVersion(), is(notNullValue()));        }        assertThat(result.get(0).getName(), is(equalTo("Article1")));    }    @Test    public void searchByAllFields_2_withSort() {        List<Article> result = this.repository.findByQuery(QueryBuilders.matchPhraseQuery("search_fields", "E2"), Sort.by(Sort.Direction.ASC, "name"));        assertThat(result.size(), is(equalTo(1)));        for (Article article : result) {            assertThat(article.getDocumentId(), is(notNullValue()));            assertThat(article.getDocumentVersion(), is(notNullValue()));        }        assertThat(result.get(0).getName(), is(equalTo("Article2")));    }    @Test    public void searchArticleInfoByDescription_withScroll() {        Pageable pageable = PageRequest.of(0, 2, Sort.by(Sort.Direction.ASC, "name"));        Page<ArticleInfo> result = this.repository.findByQuery(QueryBuilders.matchAllQuery(), pageable, ArticleInfo.class);        assertThat(((ScrolledPage<ArticleInfo>) result).getScrollId(), is(notNullValue()));        assertThat(result.getTotalElements(), is(equalTo(5L)));        assertThat(result.getContent().size(), is(equalTo(2)));        assertThat(result.getContent().get(0).getName(), is(equalTo("Article1")));        assertThat(result.getContent().get(1).getName(), is(equalTo("Article2")));        result = this.repository.continueScroll(((ScrolledPage<ArticleInfo>) result).getScrollId(), Duration.ofMinutes(1), ArticleInfo.class);        assertThat(result.getTotalElements(), is(equalTo(5L)));        assertThat(result.getContent().size(), is(equalTo(2)));        assertThat(result.getContent().get(0).getName(), is(equalTo("Article3")));        assertThat(result.getContent().get(1).getName(), is(equalTo("Article4")));    }    @Test    public void findArticleByEntrepotOrderByNameDesc() {        List<Article> result = this.repository.findArticleByEntrepotOrderByNameDesc(Article.EnumEntrepot.E1);        assertThat(result.size(), is(equalTo(3)));        for (Article article : result) {            assertThat(article.getDocumentId(), is(notNullValue()));            assertThat(article.getDocumentVersion(), is(notNullValue()));        }        assertThat(result.get(0).getName(), is(equalTo("Article5")));        assertThat(result.get(1).getName(), is(equalTo("Article4")));        assertThat(result.get(2).getName(), is(equalTo("Article1")));    }    @Test    public void findArticleByEntrepot() {        Pageable pageable = PageRequest.of(0, 2, Sort.by(Sort.Direction.ASC, "name"));        Page<Article> result = this.repository.findArticleByEntrepot(Article.EnumEntrepot.E1, pageable);        assertThat(result.getTotalElements(), is(equalTo(3L)));        for (Article article : result.getContent()) {            assertThat(article.getDocumentId(), is(notNullValue()));            assertThat(article.getDocumentVersion(), is(notNullValue()));        }        assertThat(result.getContent().size(), is(equalTo(2)));        assertThat(result.getContent().get(0).getName(), is(equalTo("Article1")));        assertThat(result.getContent().get(1).getName(), is(equalTo("Article4")));        result = this.repository.continueScroll(((ScrolledPage<Article>) result).getScrollId(), Duration.ofMinutes(1));        assertThat(result.getTotalElements(), is(equalTo(3L)));        assertThat(result.getContent().size(), is(equalTo(1)));        assertThat(result.getContent().get(0).getName(), is(equalTo("Article5")));    }    @Test    public void count() {        assertThat(this.repository.count(), is(equalTo(5L)));    }    @Test    public void countByCriteria() {        assertThat(this.repository.count(Criteria.where("entrepot").is(Article.EnumEntrepot.E1)), is(equalTo(3L)));    }    @Test    public void countByQuery() {        assertThat(this.repository.count(QueryBuilders.matchAllQuery()), is(equalTo(5L)));    }    @Test    public void countByEntrepot() {        assertThat(this.repository.countArticleByEntrepot(Article.EnumEntrepot.E1), is(equalTo(3L)));    }    @Test    public void countByDescription() {        assertThat(this.repository.countByDescriptionContains("3"), is(equalTo(1L)));    }    @Test    public void searchWithOrCriteria() {        List<Article> result = this.repository.findByQuery(Criteria.where("name").is("Article1").or("name").is("Article2"), Sort.by(Sort.Direction.ASC, "name"));        assertThat(result.size(), is(equalTo(2)));        assertThat(result.get(0).getName(), is(equalTo("Article1")));        assertThat(result.get(1).getName(), is(equalTo("Article2")));    }    @Test    public void searchWithNegativeCriteria() {        List<Article> result = this.repository.findByQuery(Criteria.where("name").is("Article1").not(), Sort.by(Sort.Direction.ASC, "name"));        assertThat(result.size(), is(equalTo(4)));        assertThat(result.get(0).getName(), is(equalTo("Article2")));        assertThat(result.get(1).getName(), is(equalTo("Article3")));        assertThat(result.get(2).getName(), is(equalTo("Article4")));        assertThat(result.get(3).getName(), is(equalTo("Article5")));    }    @Test    public void searchWithCriteriaByNameAndEntrepot() {        List<Article> result = this.repository.findByQuery(Criteria.where("name").is("Article1").and("entrepot").is(Article.EnumEntrepot.E1.name()), Sort.by(Sort.Direction.ASC, "name"));        assertThat(result.size(), is(equalTo(1)));        assertThat(result.get(0).getName(), is(equalTo("Article1")));    }    @Test    public void searchWithCriteriaByNameAndEntrepotWithPageable() {        Page<Article> result = this.repository.findByQuery(Criteria.where("name").is("Article1").and("entrepot").is(Article.EnumEntrepot.E1.name()),                PageRequest.of(0, 10, Sort.by(Sort.Direction.ASC, "name")));        assertThat(result.getTotalElements(), is(equalTo(1L)));        assertThat(result.getContent().get(0).getName(), is(equalTo("Article1")));    }    @Test    public void searchWithCriteriaByNameAndEntrepotWithPageableAndProjection() {        Page<ArticleInfo> result = this.repository.findByQuery(Criteria.where("name").is("Article1").and("entrepot").is(Article.EnumEntrepot.E1.name()),                PageRequest.of(0, 10, Sort.by(Sort.Direction.ASC, "name")),                ArticleInfo.class);        assertThat(result.getTotalElements(), is(equalTo(1L)));        assertThat(result.getContent().get(0).getName(), is(equalTo("Article1")));        this.repository.clearSearch(((ScrolledPage<ArticleInfo>) result).getScrollId());    }    @Test    public void findByEntrepot() {        List<Article> result = this.repository.findByEntrepot(Article.EnumEntrepot.E1);        assertThat(result.size(), is(equalTo(3)));    }    @Test    public void findByEntrepotOrderByNameAsc() {        List<Article> result = this.repository.findByEntrepotOrderByNameAsc(Article.EnumEntrepot.E1);        assertThat(result.size(), is(equalTo(3)));        assertThat(result.get(0).getName(), is(equalTo("Article1")));        assertThat(result.get(1).getName(), is(equalTo("Article4")));        assertThat(result.get(2).getName(), is(equalTo("Article5")));    }    @Test    public void findByName() {        Article result = this.repository.findByName("Article1");        assertThat(result.getName(), is(equalTo("Article1")));    }    @Test    public void findByNameQuery() {        Article result = this.repository.findByNameQuery("Article1");        assertThat(result.getName(), is(equalTo("Article1")));    }    @Test    public void findByEntrepotQuery() {        List<Article> result = this.repository.findByEntrepotQuery(Article.EnumEntrepot.E1);        assertThat(result.size(), is(equalTo(3)));    }    @Test    public void findByEntrepotQueryWithPageable() {        Page<Article> result = this.repository.findByEntrepotQuery(Article.EnumEntrepot.E1, PageRequest.of(0, 5));        assertThat(result.getTotalElements(), is(equalTo(3L)));    }    @Configuration    @EnableAspectJAutoProxy    @EnableAutoConfiguration    @EnableElasticsearchRepositories(            basePackages = "com.github.ydespreaux.spring.data.elasticsearch.repositories.template",            namedQueriesLocation = "classpath:named-queries/*-named-queries.properties")    static class ElasticsearchConfiguration extends ElasticsearchConfigurationSupport {        @Bean        ClientLoggerAspect clientLoggerAspect() {            return new ClientLoggerAspect();        }    }}